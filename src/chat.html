<!DOCTYPE html>
<!--
  UI updated to a modern dark theme.
  Core functionality (IDs, forms, WebSocket behavior) kept the same.
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!--===================================================================================-->
    <!-- Inline style to avoid an extra round trip before the page can render. -->
    <style type="text/css">
      * {
        box-sizing: border-box;
      }

      :root {
        --bg-main: #020617;
        --bg-elevated: rgba(15, 23, 42, 0.96);
        --bg-soft: rgba(15, 23, 42, 0.88);
        --accent: #6366f1;
        --accent-soft: rgba(99, 102, 241, 0.25);
        --border-subtle: rgba(148, 163, 184, 0.25);
        --text-main: #e5e7eb;
        --text-soft: #9ca3af;
        --danger: #f97373;
      }

      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        color: var(--text-main);
        background:
          radial-gradient(circle at top left, #1d2538 0, transparent 55%),
          radial-gradient(circle at bottom right, #020617 0, #020617 55%);
        overflow: hidden;
      }

      /* Main chat layout */

      #chatlog {
        position: fixed;
        top: 0;
        bottom: 64px;
        left: 0;
        right: 260px;
        overflow-y: auto;
        padding: 16px 20px 16px 24px;
        overflow-wrap: break-word;
        background: var(--bg-elevated);
        border-right: 1px solid var(--border-subtle);
        backdrop-filter: blur(18px);
      }

      #chatlog span.username {
        font-weight: 600;
        color: #c4d0ff;
      }

      #spacer {
        height: 8px;
      }

      #roster {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 64px;
        width: 260px;
        padding: 16px 18px;
        font-weight: 500;
        background: var(--bg-soft);
        border-left: 1px solid var(--border-subtle);
        backdrop-filter: blur(18px);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      #roster::before {
        content: "Online";
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 11px;
        color: var(--text-soft);
        margin-bottom: 6px;
      }

      p {
        margin-top: 0;
        margin-bottom: 6px;
        font-size: 14px;
        line-height: 1.4;
      }

      p:last-of-type {
        margin-bottom: 0;
      }

      /* Custom scrollbar (still subtle) */

      #chatlog::-webkit-scrollbar,
      #roster::-webkit-scrollbar {
        width: 6px;
      }

      #chatlog::-webkit-scrollbar-track,
      #roster::-webkit-scrollbar-track {
        background: transparent;
      }

      #chatlog::-webkit-scrollbar-thumb,
      #roster::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.35);
        border-radius: 999px;
      }

      #chatlog::-webkit-scrollbar-thumb:hover,
      #roster::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.6);
      }

      /* Chat input bar */

      #chat-input {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 64px;
        border: none;
        padding: 0 20px 0 56px;
        outline: none;
        background: var(--bg-elevated);
        border-top: 1px solid var(--border-subtle);
        color: var(--text-main);
        font-size: 15px;
      }

      #chat-input::placeholder {
        color: #64748b;
      }

      #chat-input:focus {
        box-shadow: 0 -1px 0 0 var(--accent);
      }

      #chatroom::before {
        z-index: 1;
        display: block;
        content: "➤";
        position: fixed;
        bottom: 0;
        left: 0;
        width: 56px;
        height: 64px;
        line-height: 64px;
        text-align: center;
        font-weight: 700;
        color: var(--accent);
        font-size: 18px;
        text-shadow: 0 0 12px var(--accent-soft);
      }

      /* Overlays: name + room selection */

      #name-form,
      #room-form {
        position: fixed;
        inset: 0;
        z-index: 20;
        margin: 0;
        border: none;
        padding: 0;
        background:
          radial-gradient(circle at top, rgba(99, 102, 241, 0.2) 0, transparent 55%),
          radial-gradient(circle at bottom, rgba(15, 23, 42, 0.98) 0, rgba(15, 23, 42, 0.98) 60%);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #name-form-inner,
      #room-form-inner {
        background: rgba(15, 23, 42, 0.98);
        border-radius: 18px;
        box-shadow:
          0 20px 45px rgba(0, 0, 0, 0.75),
          0 0 0 1px var(--border-subtle);
        padding: 28px 26px 24px;
        max-width: 420px;
        width: calc(100% - 48px);
        text-align: center;
      }

      #name-form-inner h1,
      #room-form-inner h2 {
        margin: 0 0 6px;
        font-size: 22px;
        font-weight: 650;
        letter-spacing: 0.01em;
      }

      #name-form-inner p,
      #room-form-inner p {
        margin: 4px 0 10px;
        font-size: 13px;
        color: var(--text-soft);
      }

      #name-input,
      #room-name {
        width: 100%;
        margin: 14px 0 0;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: #020617;
        color: var(--text-main);
        font-size: 15px;
        text-align: center;
        outline: none;
      }

      #name-input:focus,
      #room-name:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.7);
      }

      #room-form-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 20px;
      }

      #room-form button {
        font-size: 14px;
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: 500;
      }

      #go-public {
        background: linear-gradient(135deg, var(--accent), #4f46e5);
        color: white;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.45);
      }

      #go-private {
        background: rgba(15, 23, 42, 0.9);
        border-color: var(--border-subtle);
        color: var(--text-main);
      }

      #go-public:disabled,
      #go-private:disabled,
      #room-name:disabled {
        opacity: 0.55;
        cursor: default;
      }

      /* Small helper texts */

      .hint {
        font-size: 11px;
        color: var(--text-soft);
        margin-top: 8px;
      }

      /* Mobile layout */

      @media (max-width: 800px) {
        #chatlog {
          right: 0;
        }

        #roster {
          display: none;
        }
      }

      @media (max-width: 600px) {
        #name-form-inner,
        #room-form-inner {
          padding: 22px 18px 18px;
        }

        #name-input,
        #room-name {
          font-size: 14px;
        }

        #chat-input {
          padding-left: 52px;
          font-size: 14px;
        }

        #chatroom::before {
          width: 52px;
        }
      }

      @media (max-width: 400px) {
        #name-form-inner h1,
        #room-form-inner h2 {
          font-size: 18px;
        }
      }

      /* System messages */

      .system-message {
        color: var(--text-soft);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Name overlay -->
    <form id="name-form" action="/fake-form-action">
      <div id="name-form-inner">
        <h1>Welcome</h1>
        <p>Pick a display name to join the chat.</p>
        <input id="name-input" placeholder="Display name">
        <p class="hint">Max 32 characters. You can change rooms later.</p>
      </div>
    </form>

    <!-- Room overlay -->
    <form id="room-form" action="/fake-form-action">
      <div id="room-form-inner">
        <h2>Choose a room</h2>
        <p>Join an existing public room or create a private one.</p>
        <input id="room-name" placeholder="Public room name">
        <div id="room-form-actions">
          <button id="go-public" type="submit">Join public room</button>
          <button id="go-private" type="button">Create private room</button>
        </div>
        <p class="hint">Private rooms use unique IDs you can share as a link.</p>
      </div>
    </form>

    <!-- Chat area -->
    <form id="chatroom" action="/fake-form-action">
      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      <div id="roster"></div>
      <input id="chat-input" placeholder="Type a message and press Enter…">
    </form>

    <!--===================================================================================-->
    <!-- Client-side JavaScript code for the app. Original logic preserved. -->
    <script type="text/javascript">
      let currentWebSocket = null;

      let nameForm = document.querySelector("#name-form");
      let nameInput = document.querySelector("#name-input");
      let roomForm = document.querySelector("#room-form");
      let roomNameInput = document.querySelector("#room-name");
      let goPublicButton = document.querySelector("#go-public");
      let goPrivateButton = document.querySelector("#go-private");
      let chatroom = document.querySelector("#chatroom");
      let chatlog = document.querySelector("#chatlog");
      let chatInput = document.querySelector("#chat-input");
      let roster = document.querySelector("#roster");

      // Is the chatlog scrolled to the bottom?
      let isAtBottom = true;

      let username;
      let roomname;

      let hostname = window.location.host;
      if (hostname == "") {
        // Probably testing the HTML locally.
        hostname = "edge-chat-demo.cloudflareworkers.com";
      }

      function startNameChooser() {
        nameForm.addEventListener("submit", event => {
          event.preventDefault();
          username = nameInput.value.trim();
          if (username.length > 0) {
            startRoomChooser();
          }
        });

        nameInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        nameInput.focus();
      }

      function startRoomChooser() {
        nameForm.remove();

        if (document.location.hash.length > 1) {
          roomname = document.location.hash.slice(1);
          startChat();
          return;
        }

        roomForm.addEventListener("submit", event => {
          event.preventDefault();
          roomname = roomNameInput.value.trim();
          if (roomname.length > 0) {
            startChat();
          }
        });

        roomNameInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        goPublicButton.addEventListener("click", event => {
          roomname = roomNameInput.value.trim();
          if (roomname.length > 0) {
            startChat();
          }
        });

        goPrivateButton.addEventListener("click", async event => {
          roomNameInput.disabled = true;
          goPublicButton.disabled = true;
          event.currentTarget.disabled = true;

          let response = await fetch("https://" + hostname + "/api/room", { method: "POST" });
          if (!response.ok) {
            alert("Something went wrong creating a private room.");
            document.location.reload();
            return;
          }

          roomname = await response.text();
          startChat();
        });

        roomNameInput.focus();
      }

      function startChat() {
        roomForm.remove();

        // Normalize the room name a bit.
        roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

        if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
          addChatMessage("ERROR", "Invalid room name.");
          return;
        }

        document.location.hash = "#" + roomname;

        chatInput.addEventListener("keydown", event => {
          if (event.keyCode == 38) {
            // up arrow
            chatlog.scrollBy(0, -50);
          } else if (event.keyCode == 40) {
            // down arrow
            chatlog.scrollBy(0, 50);
          } else if (event.keyCode == 33) {
            // page up
            chatlog.scrollBy(0, -chatlog.clientHeight + 50);
          } else if (event.keyCode == 34) {
            // page down
            chatlog.scrollBy(0, chatlog.clientHeight - 50);
          }
        });

        chatroom.addEventListener("submit", event => {
          event.preventDefault();

          if (currentWebSocket && chatInput.value.trim().length > 0) {
            currentWebSocket.send(JSON.stringify({ message: chatInput.value }));
            chatInput.value = "";

            // Scroll to bottom whenever sending a message.
            chatlog.scrollBy(0, 1e8);
          }
        });

        chatInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 256) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 256);
          }
        });

        chatlog.addEventListener("scroll", event => {
          isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 2;
        });

        chatInput.focus();
        document.body.addEventListener("click", event => {
          // If the user clicked somewhere in the window without selecting any text, focus the chat input.
          if (window.getSelection().toString() == "") {
            chatInput.focus();
          }
        });

        // Detect mobile keyboard appearing and disappearing, and adjust the scroll as appropriate.
        if ("visualViewport" in window) {
          window.visualViewport.addEventListener("resize", function () {
            if (isAtBottom) {
              chatlog.scrollBy(0, 1e8);
            }
          });
        }

        join();
      }

      let lastSeenTimestamp = 0;
      let wroteWelcomeMessages = false;

      function join() {
        // If we are running via wrangler dev, use ws:
        const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
        let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
        let rejoined = false;
        let startTime = Date.now();

        let rejoin = async () => {
          if (!rejoined) {
            rejoined = true;
            currentWebSocket = null;

            // Clear the roster.
            while (roster.firstChild) {
              roster.removeChild(roster.firstChild);
            }

            // Don't try to reconnect too rapidly.
            let timeSinceLastJoin = Date.now() - startTime;
            if (timeSinceLastJoin < 10000) {
              // Less than 10 seconds elapsed since last join. Pause a bit.
              await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
            }

            // OK, reconnect now!
            join();
          }
        };

        ws.addEventListener("open", event => {
          currentWebSocket = ws;

          // Send user info message.
          ws.send(JSON.stringify({ name: username }));
        });

        ws.addEventListener("message", event => {
          let data = JSON.parse(event.data);

          if (data.error) {
            addChatMessage(null, "* Error: " + data.error, true);
          } else if (data.joined) {
            let p = document.createElement("p");
            p.innerText = data.joined;
            roster.appendChild(p);
          } else if (data.quit) {
            for (let child of roster.childNodes) {
              if (child.innerText == data.quit) {
                roster.removeChild(child);
                break;
              }
            }
          } else if (data.ready) {
            // All pre-join messages have been delivered.
            if (!wroteWelcomeMessages) {
              wroteWelcomeMessages = true;
              addChatMessage(
                null,
                "* This is a simple real-time chat demo. Anyone with the link can join.",
                true
              );
              addChatMessage(
                null,
                "* Reminder: Participants are random people on the internet. Names are not verified and messages may be logged by the server.",
                true
              );
              if (roomname.length == 64) {
                addChatMessage(
                  null,
                  "* This is a private room. Invite others by sharing this page's URL.",
                  true
                );
              } else {
                addChatMessage(null, "* Welcome to #" + roomname + ". Say hi!", true);
              }
            }
          } else {
            // A regular chat message.
            if (data.timestamp > lastSeenTimestamp) {
              addChatMessage(data.name, data.message);
              lastSeenTimestamp = data.timestamp;
            }
          }
        });

        ws.addEventListener("close", event => {
          console.log("WebSocket closed, reconnecting:", event.code, event.reason);
          rejoin();
        });
        ws.addEventListener("error", event => {
          console.log("WebSocket error, reconnecting:", event);
          rejoin();
        });
      }

      function addChatMessage(name, text, isSystem = false) {
        let p = document.createElement("p");
        if (isSystem) {
          p.classList.add("system-message");
        }

        if (name) {
          let tag = document.createElement("span");
          tag.className = "username";
          tag.innerText = name + ": ";
          p.appendChild(tag);
        }

        p.appendChild(document.createTextNode(text));

        // Append the new chat line, keeping scroll at bottom if it already was.
        chatlog.appendChild(p);
        if (isAtBottom) {
          chatlog.scrollBy(0, 1e8);
        }
      }

      startNameChooser();
    </script>
    <!--===================================================================================-->
  </body>
</html>
