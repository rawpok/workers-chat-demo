<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --bg: #050712;
      --bg-elevated: #0c0f1d;
      --bg-elevated-soft: #111525;
      --accent: #4f8cff;
      --accent-soft: rgba(79, 140, 255, 0.12);
      --accent-strong: rgba(79, 140, 255, 0.35);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --text: #f7f7ff;
      --text-soft: #a2a7c4;
      --danger: #ff5c7a;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151933 0, #050712 48%, #000 100%);
      color: var(--text);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      flex: 1;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(15, 20, 45, 0.9), rgba(10, 15, 30, 0.95));
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #9bc5ff, #4f8cff 40%, #2635ff 80%);
      box-shadow: 0 0 16px rgba(79, 140, 255, 0.9);
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 15px;
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    header.app-header .status {
      font-size: 11px;
      color: var(--text-soft);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #1ddf85;
      box-shadow: 0 0 10px rgba(29, 223, 133, 0.9);
    }

    main.app-main {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(0, 0.95fr) minmax(260px, 0.8fr);
      gap: 12px;
    }

    @media (max-width: 900px) {
      main.app-main {
        grid-template-columns: 1fr;
        grid-template-rows: max-content 1fr;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(79, 140, 255, 0.12), rgba(0, 0, 0, 0.94));
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.65);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, var(--accent-soft), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .panel-title span.accent {
      color: var(--accent);
      font-size: 11px;
      text-transform: none;
      background: rgba(79, 140, 255, 0.18);
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(79, 140, 255, 0.2);
    }

    .hint {
      font-size: 12px;
      color: var(--text-soft);
      line-height: 1.5;
    }

    .step {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label.field-label {
      font-size: 12px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.95));
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input[type="text"]::placeholder {
      color: #626786;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-strong), 0 0 18px rgba(79, 140, 255, 0.4);
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.16), rgba(0, 0, 0, 0.95));
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      white-space: nowrap;
    }

    button.primary {
      background: linear-gradient(135deg, #4f8cff, #7c5cff);
      border-color: rgba(255, 255, 255, 0.16);
      box-shadow: 0 12px 25px rgba(79, 140, 255, 0.6);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.02);
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.65);
    }

    button.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #6697ff, #a26eff);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, rgba(255, 255, 255, 0.08), transparent);
      margin: 4px 0 6px;
    }

    .or-text {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      color: var(--text-soft);
      text-align: center;
      opacity: 0.8;
    }

    /* CHAT PANEL */

    .chat-shell {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    form#chatroom {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      gap: 8px;
    }

    .chat-main {
      flex: 1;
      min-height: 0;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(135deg, rgba(12, 15, 30, 0.96), rgba(6, 9, 20, 0.98));
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(160px, 1.1fr);
      overflow: hidden;
    }

    @media (max-width: 700px) {
      .chat-main {
        grid-template-columns: 1fr;
        grid-template-rows: minmax(0, 1fr) max-content;
      }
    }

    #chatlog {
      position: relative;
      overflow-y: auto;
      padding: 10px 12px 12px 12px;
      font-size: 13px;
      line-height: 1.4;
    }

    #chatlog p {
      margin: 0 0 6px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    #chatlog p.system {
      color: var(--text-soft);
      font-style: italic;
    }

    #chatlog .username {
      font-weight: 600;
      color: #b8c7ff;
    }

    #spacer {
      height: 4px;
    }

    #roster {
      border-left: 1px solid rgba(255, 255, 255, 0.05);
      background: radial-gradient(circle at top, rgba(79, 140, 255, 0.12), rgba(0, 0, 0, 0.95));
      padding: 10px 10px 12px 10px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #roster::before {
      content: "In this room";
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    #roster p {
      margin: 0;
      padding: 4px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-top: 2px;
    }

    #chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.12), rgba(0, 0, 0, 0.96));
      color: var(--text);
      padding: 9px 12px;
      font-size: 14px;
      outline: none;
    }

    #chat-input::placeholder {
      color: #7077a0;
    }

    #chat-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-strong), 0 0 18px rgba(79, 140, 255, 0.4);
    }

    .send-hint {
      font-size: 10px;
      color: var(--text-soft);
      white-space: nowrap;
      opacity: 0.8;
    }

    .send-hint code {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.55);
      padding: 2px 6px;
      border-radius: 999px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo"></div>
        <div>
          <div class="brand-title">Realtime Chat</div>
          <div class="brand-subtitle">Ephemeral rooms, just URLs</div>
        </div>
      </div>
      <div class="status">
        <span class="status-dot"></span>
        <span id="status-text">Ready</span>
      </div>
    </header>

    <main class="app-main">
      <!-- LEFT PANEL: Name + Room selection -->
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-title">
            Join a room
            <span class="accent">2 quick steps</span>
          </div>
          <p class="hint">
            Pick a display name, then choose a public room name or spin up a private one-off room with a random ID.
          </p>

          <!-- Step 1: Name -->
          <div class="step" id="step-name">
            <label class="field-label" for="name-input">Step 1 · Your name</label>
            <form id="name-form" action="/fake-form-action">
              <input id="name-input" type="text" placeholder="e.g. rawpok" autocomplete="off">
            </form>
          </div>

          <!-- Step 2: Room -->
          <div class="divider"></div>
          <div class="step" id="step-room">
            <label class="field-label" for="room-name">Step 2 · Room</label>
            <form id="room-form" action="/fake-form-action">
              <input id="room-name" type="text" placeholder="public-room-name" autocomplete="off">
              <div class="button-row">
                <button id="go-public" class="primary" type="button">Join public</button>
                <button id="go-private" class="secondary" type="button">Create private</button>
              </div>
            </form>
            <div class="or-text">or</div>
            <p class="hint">
              Public rooms are just names (like <code>#lobby</code>). Private rooms get a long random ID and are only
              discoverable by URL.
            </p>
          </div>
        </div>
      </section>

      <!-- RIGHT PANEL: Chat -->
      <section class="panel">
        <div class="panel-inner chat-shell">
          <div class="panel-title">
            Room
            <span class="accent" id="room-label">not joined</span>
          </div>

          <form id="chatroom" action="/fake-form-action">
            <div class="chat-main">
              <div id="chatlog">
                <div id="spacer"></div>
              </div>
              <div id="roster"></div>
            </div>

            <div class="input-row">
              <input id="chat-input" type="text" placeholder="Type a message and press Enter…" autocomplete="off">
              <div class="send-hint">
                <code>Enter</code> to send · <code>PgUp/PgDn</code> to scroll
              </div>
            </div>
          </form>
        </div>
      </section>
    </main>
  </div>

  <script type="text/javascript">
    let currentWebSocket = null;

    const nameForm = document.querySelector("#name-form");
    const nameInput = document.querySelector("#name-input");
    const roomForm = document.querySelector("#room-form");
    const roomNameInput = document.querySelector("#room-name");
    const goPublicButton = document.querySelector("#go-public");
    const goPrivateButton = document.querySelector("#go-private");
    const chatroom = document.querySelector("#chatroom");
    const chatlog = document.querySelector("#chatlog");
    const chatInput = document.querySelector("#chat-input");
    const roster = document.querySelector("#roster");
    const spacer = document.querySelector("#spacer");
    const roomLabel = document.querySelector("#room-label");
    const statusText = document.querySelector("#status-text");

    // Track whether chatlog is scrolled to bottom
    let isAtBottom = true;

    let username;
    let roomname;
    let hostname = window.location.host;

    let lastSeenTimestamp = 0;
    let wroteWelcomeMessages = false;
    let lastJoinTimestamp = 0;

    function setStatus(text) {
      statusText.textContent = text;
    }

    function setRoomLabel(text) {
      roomLabel.textContent = text;
    }

    function startNameChooser() {
      nameForm.addEventListener("submit", event => {
        event.preventDefault();
        username = nameInput.value.trim();
        if (username.length > 0) {
          startRoomChooser();
        }
      });

      nameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });

      nameInput.focus();
    }

    function startRoomChooser() {
      // Remove name form once we have a name.
      nameForm.remove();

      // If URL already has a hash, auto-join that room.
      if (document.location.hash.length > 1) {
        roomname = document.location.hash.slice(1);
        startChat();
        return;
      }

      roomForm.addEventListener("submit", event => {
        event.preventDefault();
        roomname = roomNameInput.value.trim();
        if (roomname.length > 0) {
          startChat();
        }
      });

      roomNameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });

      goPublicButton.addEventListener("click", event => {
        roomname = roomNameInput.value.trim();
        if (roomname.length > 0) {
          startChat();
        }
      });

      goPrivateButton.addEventListener("click", async event => {
        roomNameInput.disabled = true;
        goPublicButton.disabled = true;
        event.currentTarget.disabled = true;

        try {
          // IMPORTANT: use relative URL so it works on your own domain/Workers dev.
          const response = await fetch("/api/room", { method: "POST" });
          if (!response.ok) {
            alert("Something went wrong creating a private room.");
            document.location.reload();
            return;
          }
          roomname = await response.text();
          startChat();
        } catch (err) {
          console.error(err);
          alert("Network error creating private room.");
          document.location.reload();
        }
      });

      roomNameInput.focus();
    }

    function startChat() {
      roomForm.remove();

      // Normalize room name.
      roomname = roomname
        .replace(/[^a-zA-Z0-9_-]/g, "")
        .replace(/_/g, "-")
        .toLowerCase();

      if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
        addChatMessage(null, "Invalid room name.");
        return;
      }

      document.location.hash = "#" + roomname;
      setRoomLabel(roomname.length === 64 ? "private room" : "#" + roomname);
      setStatus("Connecting…");

      // Keyboard scrolling shortcuts
      chatInput.addEventListener("keydown", event => {
        if (event.keyCode === 38) {
          // up
          chatlog.scrollBy(0, -50);
        } else if (event.keyCode === 40) {
          // down
          chatlog.scrollBy(0, 50);
        } else if (event.keyCode === 33) {
          // page up
          chatlog.scrollBy(0, -chatlog.clientHeight + 50);
        } else if (event.keyCode === 34) {
          // page down
          chatlog.scrollBy(0, chatlog.clientHeight - 50);
        }
      });

      chatroom.addEventListener("submit", event => {
        event.preventDefault();
        if (currentWebSocket && chatInput.value.trim().length > 0) {
          currentWebSocket.send(JSON.stringify({ message: chatInput.value }));
          chatInput.value = "";
          chatlog.scrollBy(0, 1e8);
        }
      });

      chatInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 256) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 256);
        }
      });

      chatlog.addEventListener("scroll", () => {
        isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 4;
      });

      chatInput.focus();
      document.body.addEventListener("click", event => {
        if (window.getSelection().toString() === "") {
          chatInput.focus();
        }
      });

      join();
    }

    function join() {
      const wsProtocol = document.location.protocol === "http:" ? "ws://" : "wss://";
      const wsUrl = wsProtocol + hostname + "/api/room/" + roomname + "/websocket";
      let ws = new WebSocket(wsUrl);
      currentWebSocket = ws;
      let rejoined = false;
      lastJoinTimestamp = Date.now();

      const rejoin = async () => {
        if (!rejoined) {
          rejoined = true;
          currentWebSocket = null;

          // Clear roster
          while (roster.firstChild) {
            roster.removeChild(roster.firstChild);
          }

          const elapsed = Date.now() - lastJoinTimestamp;
          if (elapsed < 10000) {
            await new Promise(resolve => setTimeout(resolve, 10000 - elapsed));
          }
          setStatus("Reconnecting…");
          join();
        }
      };

      ws.addEventListener("open", () => {
        setStatus("Connected");
        ws.send(JSON.stringify({ name: username }));
      });

      ws.addEventListener("message", event => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          console.warn("Bad message", event.data);
          return;
        }

        if (data.error) {
          addChatMessage(null, "* Error: " + data.error);
        } else if (data.joined) {
          const p = document.createElement("p");
          p.innerText = data.joined;
          roster.appendChild(p);
        } else if (data.quit) {
          for (const child of Array.from(roster.childNodes)) {
            if (child.innerText === data.quit) {
              roster.removeChild(child);
              break;
            }
          }
        } else if (data.ready) {
          if (!wroteWelcomeMessages) {
            wroteWelcomeMessages = true;
            addChatMessage(
              null,
              "* This is a simple demo chat app running on your server."
            );
            addChatMessage(
              null,
              "* WARNING: Participants in this chat may be random people on the internet. " +
              "Names are not authenticated; anyone can pretend to be anyone. Chat history may be saved."
            );

            if (roomname.length === 64) {
              addChatMessage(
                null,
                "* This is a private room. You can invite someone to the room by sending them the URL."
              );
            } else {
              addChatMessage(
                null,
                "* Welcome to #" + roomname + ". Say hi!"
              );
            }
          }
        } else if (typeof data.message === "string" && data.name) {
          // Regular chat message.
          if (!data.timestamp || data.timestamp > lastSeenTimestamp) {
            addChatMessage(data.name, data.message);
            if (data.timestamp) {
              lastSeenTimestamp = data.timestamp;
            }
          }
        }
      });

      ws.addEventListener("close", event => {
        console.log("WebSocket closed:", event.code, event.reason);
        setStatus("Disconnected · trying again…");
        rejoin();
      });

      ws.addEventListener("error", event => {
        console.log("WebSocket error:", event);
        setStatus("Error · reconnecting…");
        rejoin();
      });
    }

    function addChatMessage(name, text) {
      const p = document.createElement("p");
      if (name) {
        const tag = document.createElement("span");
        tag.className = "username";
        tag.innerText = name + ": ";
        p.appendChild(tag);
      } else {
        p.classList.add("system");
      }

      p.appendChild(document.createTextNode(text));
      chatlog.appendChild(p);

      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    }

    startNameChooser();
  </script>
</body>
</html>
